<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查看文章</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="fakebook-style.css">
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-blog"></i>
            <h1>Fakebook</h1>
        </div>
        <div class="user-info">
            <div class="nav-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="nav-user-details">
                <span class="nav-username">用户名</span>
                <span class="nav-user-id">@username</span>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- 左侧栏 - 导航菜单 -->
        <aside class="sidebar sidebar-left">
            <div class="sidebar-btns" style="display: flex; flex-direction: column; gap: 18px;">
                <button class="btn outline" id="homeBtn" onclick="goHome()"><i class="fas fa-home"></i> 主页</button>
                <button class="btn outline" onclick="window.location.href='exploration.html'"><i class="fas fa-compass"></i> 探索</button>
                <button class="btn outline" onclick="window.location.href='following.html'"><i class="fas fa-heart"></i> 关注</button>
                <button class="btn outline"><i class="fas fa-envelope"></i> 私信</button>
                <button class="btn outline" id="notificationBtn"><i class="fas fa-bell"></i> 通知</button>
                <button class="btn outline"><i class="fas fa-bookmark"></i> 收藏</button>
                <button class="btn outline" onclick="window.location.href='../UserModule/editUserInfo.html'"><i class="fas fa-edit"></i> 编辑资料</button>
                <button class="btn outline" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> 退出登录</button>
                <button class="btn outline" id="createArticleBtn"><i class="fas fa-plus"></i> 新建文章</button>
            </div>
        </aside>
        
        <!-- 中间内容区 - 文章详情 -->
        <main class="content">
            <div class="article-container" id="articleContainer">
                <!-- 文章内容将在这里动态加载 -->
            </div>
            
            <div class="comments-section">
                <h3 class="comments-header">评论 (0)</h3>
                <div class="comment-form">
                    <textarea class="comment-input" id="commentInput" placeholder="写下你的评论..."></textarea>
                    <button class="comment-submit" id="commentSubmit">发表评论</button>
                </div>
                <div class="comments-list" id="commentsList">
                    <div class="no-comments">
                        <i class="far fa-comment" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                        <p>还没有评论，快来发表第一条评论吧！</p>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 右侧栏 - 用户信息 -->
        <aside class="sidebar sidebar-right">
            <div class="user-profile">
                <div class="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <h2 style="font-size: 22px; margin-bottom: 5px; color: #333;"></h2>
                <p class="user-id" style="font-size: 15px; color: #777; margin-bottom: 10px;"></p>
                <p class="user-bio" style="color: #666; font-size: 14px; line-height: 1.5; margin: 10px 0 18px 0;"></p>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="count" style="font-size: 22px; font-weight: 600; color: #3498db; margin-bottom: 5px;">0</div>
                    <div class="label" style="font-size: 13px; color: #777;">文章</div>
                </div>
                <div class="stat-item">
                    <div class="count" style="font-size: 22px; font-weight: 600; color: #3498db; margin-bottom: 5px;">0</div>
                    <div class="label" style="font-size: 13px; color: #777;">粉丝</div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // 从localStorage加载用户数据
        document.addEventListener('DOMContentLoaded', function() {
            const currentUsername = localStorage.getItem('currentUser');
            
            if (!currentUsername) {
                alert('请先登录系统');
                window.location.href = '../UserModule/login.html';
                return;
            }
            
            // 获取用户完整信息
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
            
            // 处理currentUser
            let currentUser;
            if (currentUsername === 'admin') {
                currentUser = { 
                    username: 'admin',
                    isAdmin: true
                };
            } else {
                currentUser = registeredUsers[currentUsername] || {};
                if (!currentUser.username) {
                    alert('当前用户信息不存在');
                    window.location.href = '../UserModule/login.html';
                    return;
                }
            }
            
            // 设置导航栏用户信息
            const navUsername = document.querySelector('.nav-username');
            const navUserId = document.querySelector('.nav-user-id');
            const navAvatar = document.querySelector('.nav-avatar');
            
            if (navUsername) {
                navUsername.textContent = currentUser.username;
            }
            if (navUserId) {
                navUserId.textContent = `@${currentUser.username.toLowerCase()}`;
            }
            
            // 设置导航栏头像
            if (navAvatar && currentUser.avatar) {
                navAvatar.innerHTML = '';
                const avatarImg = document.createElement('img');
                avatarImg.src = currentUser.avatar;
                avatarImg.alt = currentUser.username;
                navAvatar.appendChild(avatarImg);
            } else if (navAvatar) {
                // 如果没有头像，显示默认图标
                navAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            // 设置用户信息
            document.querySelector('.user-profile h2').textContent = currentUser.username;
            document.querySelector('.user-id').innerHTML = `@${currentUser.username.toLowerCase()} · ID: ${currentUser.studentId || '2023001'}`;
            
            // 显示用户简介
            const bioElement = document.createElement('p');
            bioElement.className = 'user-bio';
            bioElement.textContent = currentUser.bio || '这个人很懒，什么也没留下。';
            document.querySelector('.user-profile').insertBefore(
                bioElement, 
                document.querySelector('.user-profile .stats')
            );
            
            // 显示用户头像
            if (currentUser.avatar) {
                const avatarDiv = document.querySelector('.avatar');
                avatarDiv.innerHTML = '';
                const avatarImg = document.createElement('img');
                avatarImg.src = currentUser.avatar;
                avatarImg.alt = currentUser.username;
                avatarImg.style.width = '100%';
                avatarImg.style.height = '100%';
                avatarImg.style.borderRadius = '50%';
                avatarImg.style.objectFit = 'cover';
                avatarDiv.appendChild(avatarImg);
            }
            
            // 显示文章数量
            const articles = JSON.parse(localStorage.getItem('articles') || '[]');
            const userArticles = articles.filter(article => article.author === currentUser.username);
            document.querySelectorAll('.stat-item .count')[0].textContent = userArticles.length;
            
            // 显示粉丝数
            const followersCount = currentUser.followers ? currentUser.followers.length : 0;
            document.querySelectorAll('.stat-item .count')[1].textContent = followersCount;
            
            // 退出登录功能
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                window.location.href = '../UserModule/login.html';
            });
            
            // 为新建文章按钮添加跳转功能
            document.getElementById('createArticleBtn').addEventListener('click', function() {
                window.location.href = 'createArticle.html';
            });
            
            // 为通知按钮添加跳转功能
            const notificationBtn = document.getElementById('notificationBtn');
            if (notificationBtn) {
                notificationBtn.addEventListener('click', function() {
                    localStorage.setItem('viewUser', currentUsername);
                    window.location.href = 'notification.html';
                });
            }
            
            // 加载文章数据
            loadArticle();
            
            // 评论提交功能
            document.getElementById('commentSubmit').addEventListener('click', function() {
                submitComment();
            });
        });
        
        // 加载文章
        function loadArticle() {
            const articleId = localStorage.getItem('currentArticle');
            
            // 从articles中获取完整的文章信息
            const articles = JSON.parse(localStorage.getItem('articles') || '[]');
            const currentArticle = articles.find(a => a.id === articleId) || {};
            
            // 获取当前用户名和用户信息
            const currentUsername = localStorage.getItem('currentUser');
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
            
            // 获取完整的用户信息
            let currentUser;
            if (currentUsername === 'admin') {
                currentUser = { 
                    username: 'admin',
                    isAdmin: true
                };
            } else {
                currentUser = registeredUsers[currentUsername] || {};
            }
            
            if (!currentArticle.id) {
                alert('文章不存在');
                window.location.href = 'homepage.html';
                return;
            }
            
            const container = document.getElementById('articleContainer');
            
            // 格式化日期
            const date = new Date(currentArticle.date);
            const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            
            // 获取文章发布者的头像
            let authorAvatar = '../images/default_avatar.jpg';
            
            // 尝试从用户数据中获取发布者信息
            const authorUser = registeredUsers[currentArticle.author];
            
            if (authorUser && authorUser.avatar) {
                authorAvatar = authorUser.avatar;
            } else if (currentArticle.authorAvatar) {
                authorAvatar = currentArticle.authorAvatar;
            }
            
            // 处理文章标签
            let tagsHTML = '';
            if (currentArticle.tags && currentArticle.tags.length > 0) {
                tagsHTML = `
                    <div class="article-tags">
                        ${currentArticle.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                `;
            }
            
            // 处理文章封面
            let coverHTML = '';
            if (currentArticle.coverImage) {
                coverHTML = `<div class="article-cover" style="background-image: url('${currentArticle.coverImage}');"></div>`;
            } else {
                coverHTML = `
                    <div class="article-cover" style="background: linear-gradient(45deg, #3498db, #8e44ad);">
                        <i class="fas fa-file-alt"></i>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="article-header">
                    <h1 class="article-title">${currentArticle.title}</h1>
                    <div class="article-meta">
                        <div class="article-author" onclick="viewAuthorProfile('${currentArticle.author}')">
                            <img src="${authorAvatar}" alt="${currentArticle.author}" onerror="this.src='../images/default_avatar.jpg'">
                            <div class="author-info">
                                <span class="author-name">${currentArticle.author}</span>
                            </div>
                        </div>
                        <span><i class="far fa-calendar"></i> ${formattedDate}</span>
                        <span><i class="far fa-eye"></i> ${currentArticle.views || 0} 次阅读</span>
                    </div>
                    ${tagsHTML}
                </div>
                
                ${coverHTML}
                
                <div class="article-content">
                    ${currentArticle.content.replace(/\n/g, '<br>')}
                </div>
                
                <div class="article-actions">
                    <div class="action-buttons">
                        <button class="action-btn ${currentArticle.liked ? 'liked' : ''}" id="likeBtn" onclick="toggleLike()">
                            <i class="${currentArticle.liked ? 'fas' : 'far'} fa-heart"></i>
                            <span id="likeCount">${currentArticle.likes || 0}</span>
                        </button>
                        <button class="action-btn" onclick="shareArticle()">
                            <i class="fas fa-share"></i>
                            <span>分享</span>
                        </button>
                        <button class="action-btn" onclick="bookmarkArticle()">
                            <i class="far fa-bookmark"></i>
                            <span>收藏</span>
                        </button>
                        ${currentArticle.author === currentUser.username ? `
                            <button class="action-btn delete-btn" onclick="deleteArticle()">
                                <i class="fas fa-trash"></i>
                                <span>删除</span>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // 加载评论
            loadComments(currentArticle.id);
        }
        
        // 切换点赞状态
        function toggleLike() {
            const likeBtn = document.getElementById('likeBtn');
            const likeCount = document.getElementById('likeCount');
            
            const articleId = localStorage.getItem('currentArticle');
            const articles = JSON.parse(localStorage.getItem('articles') || '[]');
            const currentArticle = articles.find(a => a.id === articleId) || {};
            
            // 获取当前用户名和用户信息
            const currentUsername = localStorage.getItem('currentUser');
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
            
            // 获取完整的用户信息
            let currentUser;
            if (currentUsername === 'admin') {
                currentUser = { 
                    username: 'admin',
                    isAdmin: true
                };
            } else {
                currentUser = registeredUsers[currentUsername] || {};
            }
            
            // 更新文章数据
            const articleIndex = articles.findIndex(a => a.id === currentArticle.id);
            
            if (articleIndex !== -1) {
                if (!articles[articleIndex].liked) {
                    articles[articleIndex].liked = true;
                    articles[articleIndex].likes = (articles[articleIndex].likes || 0) + 1;
                    likeBtn.classList.add('liked');
                    likeBtn.querySelector('i').className = 'fas fa-heart';
                    
                    // 给文章作者发送点赞通知
                    if (currentUser.username && currentUser.username !== currentArticle.author) {
                        addNotification('like_on_post', currentUser.username, currentArticle.author);
                    }
                } else {
                    articles[articleIndex].liked = false;
                    articles[articleIndex].likes = Math.max(0, (articles[articleIndex].likes || 0) - 1);
                    likeBtn.classList.remove('liked');
                    likeBtn.querySelector('i').className = 'far fa-heart';
                }
                
                likeCount.textContent = articles[articleIndex].likes;
                localStorage.setItem('articles', JSON.stringify(articles));
            }
        }
        
        // 分享文章
        function shareArticle() {
            const articleId = localStorage.getItem('currentArticle');
            const articles = JSON.parse(localStorage.getItem('articles') || '[]');
            const currentArticle = articles.find(a => a.id === articleId) || {};
            if (navigator.share) {
                navigator.share({
                    title: currentArticle.title,
                    text: currentArticle.content.substring(0, 100) + '...',
                    url: window.location.href
                });
            } else {
                // 复制链接到剪贴板
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('链接已复制到剪贴板');
                });
            }
        }
        
        // 收藏文章
        function bookmarkArticle() {
            alert('收藏功能开发中...');
        }
        
        // 删除文章
        function deleteArticle() {
            const articleId = localStorage.getItem('currentArticle');
            const articles = JSON.parse(localStorage.getItem('articles') || '[]');
            const currentArticle = articles.find(a => a.id === articleId) || {};
            
            // 获取当前用户名和用户信息
            const currentUsername = localStorage.getItem('currentUser');
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
            
            // 获取完整的用户信息
            let currentUser;
            if (currentUsername === 'admin') {
                currentUser = { 
                    username: 'admin',
                    isAdmin: true
                };
            } else {
                currentUser = registeredUsers[currentUsername] || {};
            }
            
            // 确认删除
            if (!confirm('确定要删除这篇文章吗？删除后无法恢复。')) {
                return;
            }
            
            // 从文章列表中删除（评论会随文章一起删除，因为评论现在存储在文章对象中）
            const updatedArticles = articles.filter(article => article.id !== currentArticle.id);
            localStorage.setItem('articles', JSON.stringify(updatedArticles));
            
            // 清除当前文章数据
            localStorage.removeItem('currentArticle');
            
            alert('文章删除成功！');
            
            // 跳转回主页
            window.location.href = 'homepage.html';
        }
        
        // 提交评论
        function submitComment() {
            const commentInput = document.getElementById('commentInput');
            const comment = commentInput.value.trim();
            
            const articleId = localStorage.getItem('currentArticle');
            const articles = JSON.parse(localStorage.getItem('articles') || '[]');
            const currentArticle = articles.find(a => a.id === articleId) || {};
            
            // 获取当前用户名和用户信息
            const currentUsername = localStorage.getItem('currentUser');
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
            
            // 获取完整的用户信息
            let currentUser;
            if (currentUsername === 'admin') {
                currentUser = { 
                    username: 'admin',
                    isAdmin: true
                };
            } else {
                currentUser = registeredUsers[currentUsername] || {};
            }
            
            if (!comment) {
                alert('请输入评论内容');
                return;
            }
            
            if (!currentUser.username) {
                alert('请先登录');
                return;
            }
            
            // 创建新评论
            const newComment = {
                id: Date.now().toString(),
                content: comment,
                author: currentUser.username,
                authorAvatar: currentUser.avatar || '../images/default_avatar.jpg',
                date: new Date().toISOString(),
                articleId: currentArticle.id
            };
            
            // 将评论保存到文章对象中
            const articleIndex = articles.findIndex(article => article.id === currentArticle.id);
            
            if (articleIndex !== -1) {
                // 确保comments数组存在
                if (!articles[articleIndex].comments) {
                    articles[articleIndex].comments = [];
                }
                
                // 添加新评论到文章对象
                articles[articleIndex].comments.push(newComment);
                
                // 更新localStorage中的文章数据
                localStorage.setItem('articles', JSON.stringify(articles));
                
                // 我们不需要更新currentArticle，因为它现在是ID引用
            }
            
            // 给文章作者发送评论通知
            if (currentUser.username !== currentArticle.author) {
                addNotification('comment_on_post', currentUser.username, currentArticle.author);
            }
            
            // 清空输入框
            commentInput.value = '';
            
            // 重新加载评论
            loadComments(currentArticle.id);
        }
        
        // 加载评论
        function loadComments(articleId) {
            // 从articles中获取完整的文章信息
            const articles = JSON.parse(localStorage.getItem('articles') || '[]');
            const article = articles.find(a => a.id === articleId) || {};
            const articleComments = article.comments || [];
            const commentsList = document.getElementById('commentsList');
            
            // 更新评论数量
            document.querySelector('.comments-header').textContent = `评论 (${articleComments.length})`;
            
            if (articleComments.length === 0) {
                commentsList.innerHTML = `
                    <div class="no-comments">
                        <i class="far fa-comment" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                        <p>还没有评论，快来发表第一条评论吧！</p>
                    </div>
                `;
                return;
            }
            
            // 获取用户数据用于显示评论者头像
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
            
            commentsList.innerHTML = articleComments.map(comment => {
                const date = new Date(comment.date);
                const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                // 获取评论者头像
                let commenterAvatar = '../images/default_avatar.jpg';
                const commenterUser = registeredUsers[comment.author];
                
                if (commenterUser && commenterUser.avatar) {
                    commenterAvatar = commenterUser.avatar;
                } else if (comment.authorAvatar) {
                    commenterAvatar = comment.authorAvatar;
                }
                
                return `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div class="comment-author-info">
                                <img src="${commenterAvatar}" alt="${comment.author}" class="comment-avatar" onerror="this.src='../images/default_avatar.jpg'">
                                <div class="comment-author-details">
                                    <span class="comment-author">${comment.author}</span>
                                    <span class="comment-date">${formattedDate}</span>
                                </div>
                            </div>
                        </div>
                        <div class="comment-content">${comment.content}</div>
                    </div>
                `;
            }).join('');
        }
        
        // 查看作者资料
        function viewAuthorProfile(authorName) {
            // 获取所有注册用户
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
            if (authorName === 'admin' || registeredUsers[authorName]) {
                // 设置viewUser为作者用户名
                localStorage.setItem('viewUser', authorName);
                // 跳转到主页
                window.location.href = 'homepage.html';
            } else {
                alert('未找到该用户信息');
            }
        }
        
        // 添加通知函数
        function addNotification(type, fromUser, targetUser) {
            // 获取用户数据
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
            const user = registeredUsers[targetUser];
            
            if (!user) return;
            
            // 初始化notices数组（如果不存在）
            if (!user.notices) {
                user.notices = [];
            }
            
            // 根据通知类型生成content
            let content = '';
            switch(type) {
                case 'post_published':
                    content = `你关注的${fromUser}发布了新文章，快去看看吧`;
                    break;
                case 'comment_on_post':
                    content = `你的文章有新的评论`;
                    break;
                case 'like_on_post':
                    content = `你的文章有新的点赞`;
                    break;
                case 'new_follower':
                    content = `有位用户${fromUser}成为了你的新粉丝`;
                    break;
                default:
                    content = '你有一条新通知';
            }
            
            const newNotification = {
                id: Date.now() + '_' + Math.floor(Math.random()*10000),
                type: type,
                fromUser: fromUser,
                targetUser: targetUser,
                content: content,
                time: new Date().toLocaleString(),
                isRead: false
            };
            
            // 将新通知添加到通知列表的最前面
            user.notices.unshift(newNotification);
            
            // 保存回localStorage
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
        }

        function goHome() {
            const currentUsername = localStorage.getItem('currentUser');
            localStorage.setItem('viewUser', currentUsername);
            window.location.href = 'homepage.html';
        }
        
    </script>
</body>
</html> 